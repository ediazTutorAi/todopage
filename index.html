<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My To-Do + Reminders</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --pad: 14px; --radius: 14px; }
    body { font-family: system-ui, sans-serif; max-width: 720px; margin: 3rem auto; padding: 0 1rem; }
    header { display: flex; align-items: center; gap: .75rem; justify-content: space-between; }
    h1 { font-size: 1.4rem; margin: 0; }
    .row { display: flex; gap: .5rem; margin: 1rem 0; flex-wrap: wrap; }
    input, button, select { padding: .6rem .7rem; border-radius: 10px; border: 1px solid #ddd; }
    input[type="text"] { flex: 1 1 280px; }
    .pill { border-radius: 999px; }
    ul { list-style: none; padding: 0; margin: 1rem 0; }
    li { display: grid; grid-template-columns: 1fr auto; gap: .6rem; align-items: center;
         padding: .65rem .75rem; border: 1px solid #eee; border-radius: var(--radius); margin-bottom: .5rem; }
    .title { display: flex; gap: .6rem; align-items: center; }
    .title input[type="checkbox"] { width: 1.1rem; height: 1.1rem; }
    .meta { font-size: .85rem; color: #666; }
    .done .label { text-decoration: line-through; color: #8a8a8a; }
    .overdue { border-color: #ffb1b1; background: #fff6f6; }
    .soon { border-color: #ffe1a6; background: #fffbf2; }
    .controls button { margin-left: .3rem; }
    .muted { color: #999; }
    .footer { display:flex; justify-content: space-between; align-items:center; margin-top: 1rem; font-size: .9rem; }
    .chip { padding: .25rem .6rem; border: 1px solid #ddd; border-radius: 999px; cursor: pointer; }
    .chip.active { background: #111; color: #fff; border-color:#111; }
    .hint { font-size: .85rem; color: #666; }
  </style>

  <!-- SEED: edit this JSON in VS Code to prefill on first load (or after a Hard Reset). -->
  <script type="application/json" id="seed">
  [
    { "text": "Example: Draft Calc II slide 1‚Äì3", "due": "", "done": false, "tag":"work" },
    { "text": "Order 2x PETG sheets", "due": "", "done": false, "tag":"home" },
    { "text": "Email Pedro about MathAgora LTI", "due": "", "done": false, "tag":"work" }
  ]
  </script>
</head>
<body>
  <header>
    <h1>‚úÖ My To-Do + Reminders</h1>
    <div class="row" style="margin:0">
      <button id="notifyBtn" class="pill" title="Enable desktop notifications">üîî Notifications</button>
      <button id="hardResetBtn" class="pill" title="Clear local data so seed changes take effect">‚ôªÔ∏è Hard Reset</button>
    </div>
  </header>

  <div class="row">
    <input id="taskText" type="text" placeholder="New task (Enter to add)" />
    <input id="taskDue" type="datetime-local" />
    <select id="taskTag" title="Tag">
      <option value="">tag‚Ä¶</option>
      <option>work</option>
      <option>home</option>
      <option>teaching</option>
      <option>research</option>
    </select>
    <button id="addBtn">Add</button>
  </div>

  <div class="row" style="align-items:center">
    <span class="hint">Filter:</span>
    <span class="chip active" data-filter="all">All</span>
    <span class="chip" data-filter="open">Open</span>
    <span class="chip" data-filter="done">Done</span>
    <span class="chip" data-filter="overdue">Overdue</span>
    <span class="chip" data-filter="soon">Due in 24h</span>
    <span class="chip" data-filter="work">@work</span>
    <span class="chip" data-filter="home">@home</span>
  </div>

  <ul id="list"></ul>

  <div class="footer">
    <span class="muted" id="count"></span>
    <div>
      <button id="exportBtn">Export</button>
      <input id="importFile" type="file" accept="application/json" style="display:none" />
      <button id="importBtn">Import</button>
    </div>
  </div>

<script>
(() => {
  const STORAGE_KEY = "todo.v1";
  /** Load or seed */
  let tasks = load();

  // --- Elements
  const list = document.getElementById("list");
  const taskText = document.getElementById("taskText");
  const taskDue = document.getElementById("taskDue");
  const taskTag = document.getElementById("taskTag");
  const count = document.getElementById("count");
  const addBtn = document.getElementById("addBtn");
  const notifyBtn = document.getElementById("notifyBtn");
  const hardResetBtn = document.getElementById("hardResetBtn");
  const exportBtn = document.getElementById("exportBtn");
  const importBtn = document.getElementById("importBtn");
  const importFile = document.getElementById("importFile");
  const chips = [...document.querySelectorAll(".chip")];
  let filter = "all";

  // --- Helpers
  function load() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) return JSON.parse(raw);
    // seed on first visit
    try {
      const seedRaw = document.getElementById("seed").textContent.trim();
      const seed = JSON.parse(seedRaw);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(seed));
      return seed;
    } catch { return []; }
  }
  function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks)); }
  function fmt(dt) { return new Date(dt).toLocaleString(); }
  function isOverdue(t) { return t.due && !t.done && new Date(t.due) < new Date(); }
  function isSoon(t) {
    if (!t.due || t.done) return false;
    const d = new Date(t.due) - new Date();
    return d > 0 && d <= 24*60*60*1000;
  }

  // --- Render
  function render() {
    list.innerHTML = "";
    let shown = tasks.filter(t => {
      switch (filter) {
        case "open": return !t.done;
        case "done": return t.done;
        case "overdue": return isOverdue(t);
        case "soon": return isSoon(t);
        case "work": return (t.tag||"") === "work";
        case "home": return (t.tag||"") === "home";
        default: return true;
      }
    });

    shown.forEach((t, i) => {
      const li = document.createElement("li");
      li.className = (t.done ? "done " : "") + (isOverdue(t) ? "overdue " : isSoon(t) ? "soon " : "");
      li.innerHTML = `
        <div class="title">
          <input type="checkbox" ${t.done ? "checked": ""} data-action="toggle" data-idx="${i}">
          <span class="label">${escapeHtml(t.text)}</span>
        </div>
        <div class="controls">
          <button data-action="snooze" data-idx="${i}" title="Snooze 1 hour">üò¥</button>
          <button data-action="edit" data-idx="${i}" title="Edit">‚úèÔ∏è</button>
          <button data-action="delete" data-idx="${i}" title="Delete">üóë</button>
          <div class="meta">${t.tag ? "¬∑ #" + t.tag : ""} ${t.due ? "¬∑ ‚è∞ " + fmt(t.due) : ""}</div>
        </div>
      `;
      list.appendChild(li);
    });

    const open = tasks.filter(t=>!t.done).length;
    count.textContent = `${tasks.length} total ¬∑ ${open} open`;
    save();
  }

  function escapeHtml(s){return s.replace(/[&<>"']/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));}

  // --- Actions
  function add() {
    const text = taskText.value.trim();
    if (!text) return;
    tasks.unshift({ text, due: taskDue.value || "", done: false, tag: (taskTag.value||"") });
    taskText.value = ""; taskDue.value = ""; taskTag.value = "";
    render();
  }
  function toggle(i) { tasks[i].done = !tasks[i].done; render(); }
  function del(i) { tasks.splice(i,1); render(); }
  function edit(i) {
    const t = tasks[i];
    const text = prompt("Edit task:", t.text);
    if (text === null) return;
    const due = prompt("Due (yyyy-mm-ddThh:mm) or blank:", t.due || "");
    const tag = prompt("Tag (optional):", t.tag || "");
    tasks[i] = { ...t, text: text.trim(), due: (due||"").trim(), tag: (tag||"").trim() };
    render();
  }
  function snooze(i) {
    const t = tasks[i];
    const base = t.due ? new Date(t.due) : new Date();
    base.setHours(base.getHours() + 1);
    t.due = base.toISOString().slice(0,16);
    render();
  }

  // --- Events
  addBtn.addEventListener("click", add);
  taskText.addEventListener("keydown", e => { if (e.key === "Enter") add(); });
  list.addEventListener("click", e => {
    const btn = e.target.closest("[data-action]");
    if (!btn) return;
    const idx = +btn.dataset.idx;
    const action = btn.dataset.action;
    if (action === "toggle") toggle(idx);
    if (action === "delete") del(idx);
    if (action === "edit") edit(idx);
    if (action === "snooze") snooze(idx);
  });

  chips.forEach(chip => chip.addEventListener("click", () => {
    chips.forEach(c=>c.classList.remove("active"));
    chip.classList.add("active");
    filter = chip.dataset.filter;
    render();
  }));

  // --- Notification opt-in (optional)
  notifyBtn.addEventListener("click", async () => {
    if (!("Notification" in window)) { alert("Notifications not supported in this browser."); return; }
    const perm = await Notification.requestPermission();
    alert(perm === "granted" ? "Desktop notifications enabled." : "Notifications denied.");
  });

  // --- Hard Reset: clears localStorage so edits to the SEED block take effect
  hardResetBtn.addEventListener("click", () => {
    if (confirm("Clear all local data and reload seed?")) {
      localStorage.removeItem(STORAGE_KEY);
      location.reload();
    }
  });

  // --- Export / Import
  exportBtn.addEventListener("click", () => {
    const blob = new Blob([JSON.stringify(tasks, null, 2)], { type: "application/json" });
    const a = Object.assign(document.createElement("a"), {
      href: URL.createObjectURL(blob), download: "tasks.json"
    });
    a.click(); URL.revokeObjectURL(a.href);
  });
  importBtn.addEventListener("click", () => importFile.click());
  importFile.addEventListener("change", async () => {
    const file = importFile.files[0]; if (!file) return;
    const text = await file.text();
    try { tasks = JSON.parse(text); save(); render(); }
    catch { alert("Invalid JSON"); }
    importFile.value = "";
  });

  // --- Reminder loop (alerts or notifications)
  const reminded = new Set();
  setInterval(() => {
    const now = new Date();
    tasks.forEach((t, i) => {
      if (!t.due || t.done) return;
      const due = new Date(t.due);
      const delta = due - now;
      if (Math.abs(delta) <= 60 * 1000 && !reminded.has(i)) {
        reminded.add(i);
        if ("Notification" in window && Notification.permission === "granted") {
          new Notification("Reminder", { body: t.text });
        } else {
          alert("Reminder: " + t.text);
        }
      }
    });
  }, 30 * 1000);

  render();
})();
</script>
</body>
</html>
